<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gear Rental – fiducia collective</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <!-- HEADER + 서브 네비 -->
    <header>
      <div class="logo-wrap">
        <div class="logo-mark"><span></span></div>
        <div class="logo-text">
          <div class="logo-text-main">FIDUCIA COLLECTIVE</div>
          <div class="logo-text-sub">Gear Rental · fiducia collective</div>
        </div>
      </div>
      <nav>
        <a href="index.html">HOME</a>
        <a href="equipment.html" class="active">GEAR</a>
        <a href="ai-stillcut.html">AI STILLCUT</a>
      </nav>

      <!-- 기어 서브 네비 (카테고리 필터 + 장바구니 스크롤) -->
      <div class="subnav">
        <button class="subnav-button active" data-category="">전체</button>
        <button class="subnav-button" data-category="촬영">촬영</button>
        <button class="subnav-button" data-category="촬영 악세서리">촬영 악세서리</button>
        <button class="subnav-button" data-category="조명">조명</button>
        <button class="subnav-button" data-category="조명 악세서리">조명 악세서리</button>
        <button class="subnav-button" data-category="음향">음향</button>
        <button class="subnav-button" data-category="연출">연출</button>
        <button class="subnav-button" data-scroll="#cart-section">장바구니</button>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <div class="hero-pill">
          <span class="hero-pill-dot"></span>
          촬영 인력과 같이 움직이는 장비 렌탈
        </div>
        <h1 class="hero-title">
          촬영 계획이 복잡할수록,<br />
          선택은 단순해져야 합니다.
        </h1>
        <p class="hero-desc">
          fiducia collective가 실제 현장에서 사용하는 장비들을<br />
          카테고리별로 정리해 둔 페이지입니다.<br />
          필요한 장비를 고르고, 날짜를 선택하면<br />
          장바구니에서 바로 내역과 금액을 확인할 수 있어요.
        </p>
        <div class="hero-meta">
          <span>장비별 실시간 예약 일정 확인</span>
          <span>학생 / 연속 촬영 할인 옵션</span>
          <span>Notion Gear DB · Reservation DB 연동</span>
        </div>
      </div>
    </section>

    <main>
      <!-- 1. 장비 선택 + 날짜 -->
      <section class="card" id="gear-section">
        <div class="card-header">
          <div>
            <div class="card-title">장비 선택</div>
            <div class="card-sub">
              Notion 기어 DB에 등록한 장비들이 여기로 불러와집니다.<br />
              하나를 선택하고, 대여 기간을 입력한 뒤 “장바구니 담기”를 눌러 주세요.
            </div>
          </div>
        </div>

        <!-- 장비 리스트: Notion 기어 DB에서 자동 로드 -->
        <div id="gear-list" class="works-grid" style="margin-bottom: 12px;">
          <p class="card-sub">장비 목록을 불러오는 중입니다…</p>
        </div>

        <p class="card-sub" id="selected-gear-text">
          선택된 장비: 아직 선택되지 않았습니다.
        </p>

        <div class="form-two-cols" style="margin-top: 10px;">
          <div class="input-group">
            <label>대여 시작일</label>
            <input type="date" id="rent-start" />
          </div>
          <div class="input-group">
            <label>반납일</label>
            <input type="date" id="rent-end" />
          </div>
        </div>

        <button type="button" id="add-to-cart" style="margin-top: 10px;">
          이 구성 장바구니 담기
        </button>

        <div id="gear-reserved" class="footer-note" style="margin-top:12px;">
          장비를 선택하면, 이미 예약된 일정이 여기 표시됩니다.
        </div>
      </section>

      <!-- 2. 장바구니 + 할인 / 내역서 -->
      <section class="card" id="cart-section">
        <div class="card-header">
          <div>
            <div class="card-title">장바구니 & 내역서</div>
            <div class="card-sub">
              담긴 장비들의 기간·금액을 한 번에 확인할 수 있습니다.<br />
              학생/연속 촬영 할인도 여기서 적용할 수 있어요.
            </div>
          </div>
        </div>

        <div id="cart-list">
          <p class="card-sub">아직 장바구니에 담긴 장비가 없습니다.</p>
        </div>

        <hr style="border-color: rgba(255,255,255,0.08); margin: 14px 0;" />

        <div class="form-two-cols">
          <div class="input-group">
            <label>할인 옵션</label>
            <select id="discount-type">
              <option value="none">할인 없음</option>
              <option value="student">학생 할인 (10%)</option>
              <option value="continuous">연속 촬영 할인 (15%)</option>
              <option value="student_continuous">학생 + 연속 (20%)</option>
            </select>
          </div>
          <div class="input-group">
            <label>할인 관련 메모</label>
            <input id="cart-memo" placeholder="예: 학생증 보유, 3일 연속 촬영 등" />
          </div>
        </div>

        <div id="summary" style="margin-top: 10px;" class="card-sub">
          총 금액: 0원
        </div>
      </section>

      <!-- 3. 예약자 정보 + 최종 전송 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">예약자 정보</div>
            <div class="card-sub">
              예약 확정 안내를 위해 필요한 최소 정보입니다.<br />
              실제 픽업/반납 및 결제 관련 안내는 별도 연락으로 진행됩니다.
            </div>
          </div>
        </div>

        <form id="reserve-form">
          <div class="form-two-cols">
            <div class="input-group">
              <label>예약자 이름 (RenterName)</label>
              <input id="RenterName" placeholder="예: 홍길동" />
            </div>
            <div class="input-group">
              <label>연락처 (Contact)</label>
              <input id="Contact" placeholder="010-0000-0000" />
            </div>
          </div>

          <div class="input-group">
            <label>프로젝트명 (ProjectName)</label>
            <input
              id="ProjectName"
              placeholder="예: 브랜드 필름 / 웨딩 / 룩북 / MV"
            />
          </div>

          <div class="input-group">
            <label>추가 메모 (Memo)</label>
            <textarea
              id="Memo"
              placeholder="픽업/반납 시간, 차량, 촬영 장소, 기타 특이사항 등을 적어 주세요."
            ></textarea>
          </div>

          <button type="button" id="submit-reservation">
            장비 예약 요청 보내기
          </button>
          <p class="footer-note">
            장바구니 내역과 할인 옵션이 장비별로 나뉘어 Notion Gear Reservation DB에 저장됩니다.<br />
            실제 금액·보증 관련 최종 안내는 fiducia collective에서 개별 연락드립니다.
          </p>
        </form>
      </section>
    </main>
  </div>

  <script>
    // ---------- 공통 함수 ----------
    function calcDays(startStr, endStr) {
      const s = new Date(startStr);
      const e = new Date(endStr);
      if (isNaN(s) || isNaN(e)) return 0;
      const diff = e - s;
      return diff < 0
        ? 0
        : Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
    }

    // ---------- 전역 변수 ----------
    let selectedGear = null;
    let allGears = [];
    const gearListEl = document.getElementById("gear-list");
    const selectedGearText = document.getElementById("selected-gear-text");
    const reservedBox = document.getElementById("gear-reserved");

    const cart = [];
    const cartListEl = document.getElementById("cart-list");
    const discountSelect = document.getElementById("discount-type");
    const summaryEl = document.getElementById("summary");

    // ---------- 서브 네비 동작 ----------
    document.querySelectorAll(".subnav-button").forEach((btn) => {
      btn.addEventListener("click", () => {
        const scrollTarget = btn.dataset.scroll;
        const category = btn.dataset.category;

        document
          .querySelectorAll(".subnav-button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        if (scrollTarget) {
          const el = document.querySelector(scrollTarget);
          if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
        } else {
          // 카테고리 필터
          renderGearList(category || "");
          selectedGear = null;
          selectedGearText.textContent =
            "선택된 장비: 아직 선택되지 않았습니다.";
          reservedBox.textContent =
            "장비를 선택하면, 이미 예약된 일정이 여기 표시됩니다.";
        }
      });
    });

    // ---------- 기어 리스트 로드 ----------
    async function loadGearList() {
      try {
        const res = await fetch("/.netlify/functions/gear-list");
        const json = await res.json();
        if (!json.ok) {
          gearListEl.innerHTML =
            '<p class="card-sub">장비 목록을 불러오지 못했습니다. (나중에 다시 확인해 주세요)</p>';
          return;
        }

        allGears = json.items || [];
        renderGearList(""); // 전체
      } catch (e) {
        console.error(e);
        gearListEl.innerHTML =
          '<p class="card-sub">장비 목록을 불러오는 중 오류가 발생했습니다.</p>';
      }
    }

    function renderGearList(filterCategory) {
      if (!allGears.length) {
        gearListEl.innerHTML =
          '<p class="card-sub">등록된 장비가 없습니다. Notion 기어 DB를 확인해 주세요.</p>';
        return;
      }

      const list = document.createElement("div");
      list.className = "works-grid";

      allGears
        .filter((g) =>
          filterCategory ? g.category === filterCategory : true
        )
        .forEach((gear) => {
          const card = document.createElement("div");
          card.className = "work-item gear-item";
          card.dataset.gearName = gear.name;
          card.dataset.price = gear.dayPrice || 0;

          if (gear.photoUrl) {
            const thumb = document.createElement("div");
            thumb.className = "work-thumb";
            thumb.style.backgroundImage = `url('${gear.photoUrl}')`;
            card.appendChild(thumb);
          }

          const info = document.createElement("div");
          info.className = "work-info";

          const titleEl = document.createElement("div");
          titleEl.className = "work-title";
          titleEl.textContent =
            gear.name +
            (gear.dayPrice
              ? " · " + gear.dayPrice.toLocaleString() + "원/일"
              : "");
          info.appendChild(titleEl);

          if (gear.description) {
            const descEl = document.createElement("div");
            descEl.className = "work-subtitle";
            descEl.textContent = gear.description;
            info.appendChild(descEl);
          }

          const catEl = document.createElement("div");
          catEl.className = "work-role";
          catEl.textContent = gear.category || "기타";
          info.appendChild(catEl);

          card.appendChild(info);
          list.appendChild(card);
        });

      gearListEl.innerHTML = "";
      gearListEl.appendChild(list);

      attachGearItemEvents();
    }

    // ---------- 장비 선택 & 예약 일정 ----------
    function attachGearItemEvents() {
      document.querySelectorAll(".gear-item").forEach((item) => {
        item.addEventListener("click", () => {
          document
            .querySelectorAll(".gear-item")
            .forEach((i) => (i.style.outline = "none"));

          item.style.outline = "1px solid rgba(255,255,255,0.6)";

          selectedGear = {
            gearName: item.dataset.gearName,
            pricePerDay: Number(item.dataset.price || 0),
          };

          selectedGearText.textContent =
            "선택된 장비: " +
            selectedGear.gearName +
            (selectedGear.pricePerDay
              ? " · " +
                selectedGear.pricePerDay.toLocaleString() +
                "원/일"
              : "");

          loadGearReservations(selectedGear.gearName);
        });
      });
    }

    async function loadGearReservations(gearName) {
      reservedBox.textContent =
        "선택된 장비의 예약 일정을 불러오는 중입니다…";
      try {
        const res = await fetch(
          "/.netlify/functions/gear-reservations?gear=" +
            encodeURIComponent(gearName)
        );
        const json = await res.json();
        if (!json.ok) {
          reservedBox.textContent =
            "예약 일정을 불러오지 못했습니다. (나중에 다시 확인해 주세요)";
          return;
        }
        const items = json.items || [];
        if (!items.length) {
          reservedBox.textContent =
            "이 장비는 아직 등록된 예약이 없습니다.";
          return;
        }
        const lines = items
          .map((r) => `${r.start} ~ ${r.end || r.start}`)
          .join("\n");
        reservedBox.textContent =
          "이미 예약된 일정:\n" + lines;
      } catch (e) {
        console.error(e);
        reservedBox.textContent =
          "예약 일정을 불러오는 중 오류가 발생했습니다.";
      }
    }

    // ---------- 장바구니 ----------
    function renderCart() {
      if (!cart.length) {
        cartListEl.innerHTML =
          '<p class="card-sub">아직 장바구니에 담긴 장비가 없습니다.</p>';
        summaryEl.textContent = "총 금액: 0원";
        return;
      }

      const list = document.createElement("div");
      list.className = "form-meta-grid";

      let subtotal = 0;

      cart.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "form-meta-item";

        const label = document.createElement("span");
        label.className = "label";
        label.textContent =
          item.gearName +
          " · " +
          item.pricePerDay.toLocaleString() +
          "원/일";

        const value = document.createElement("span");
        value.className = "value";
        value.textContent =
          item.start +
          " ~ " +
          item.end +
          " · " +
          item.days +
          "일 · " +
          item.totalPrice.toLocaleString() +
          "원";

        subtotal += item.totalPrice;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn-secondary";
        removeBtn.style.fontSize = "10px";
        removeBtn.style.marginTop = "6px";
        removeBtn.textContent = "삭제";
        removeBtn.addEventListener("click", () => {
          cart.splice(idx, 1);
          renderCart();
        });

        div.appendChild(label);
        div.appendChild(value);
        div.appendChild(removeBtn);
        list.appendChild(div);
      });

      cartListEl.innerHTML = "";
      cartListEl.appendChild(list);

      let discountRate = 0;
      const type = discountSelect.value;
      if (type === "student") discountRate = 0.1;
      else if (type === "continuous") discountRate = 0.15;
      else if (type === "student_continuous") discountRate = 0.2;

      const discountAmount = Math.floor(subtotal * discountRate);
      const finalTotal = subtotal - discountAmount;

      summaryEl.innerHTML =
        "상품 금액: " +
        subtotal.toLocaleString() +
        "원<br>" +
        "할인: " +
        (discountAmount ? "- " + discountAmount.toLocaleString() + "원" : "0원") +
        "<br><strong>최종 결제 예상 금액: " +
        finalTotal.toLocaleString() +
        "원</strong>";
    }

    discountSelect.addEventListener("change", renderCart);

    document
      .getElementById("add-to-cart")
      .addEventListener("click", () => {
        const start = document.getElementById("rent-start").value;
        const end = document.getElementById("rent-end").value;

        if (!selectedGear) {
          alert("먼저 장비 하나를 선택해 주세요.");
          return;
        }
        if (!start || !end) {
          alert("대여 시작일과 반납일을 입력해 주세요.");
          return;
        }

        const days = calcDays(start, end);
        if (!days) {
          alert("기간이 잘못되었습니다.");
          return;
        }

        const totalPrice = selectedGear.pricePerDay * days;

        cart.push({
          gearName: selectedGear.gearName,
          pricePerDay: selectedGear.pricePerDay,
          start,
          end,
          days,
          totalPrice,
        });

        renderCart();
      });

    // ---------- 최종 예약 전송 ----------
    document
      .getElementById("submit-reservation")
      .addEventListener("click", async () => {
        const renterName = document.getElementById("RenterName").value;
        const contact = document.getElementById("Contact").value;
        const projectName = document.getElementById("ProjectName").value;
        const memo = document.getElementById("Memo").value;
        const cartMemo = document.getElementById("cart-memo").value;
        const discountType = discountSelect.value;

        if (!renterName || !contact || !projectName) {
          alert("이름 / 연락처 / 프로젝트명은 꼭 입력해 주세요.");
          return;
        }
        if (!cart.length) {
          alert("장바구니에 최소 1개 이상의 장비를 담아 주세요.");
          return;
        }

        const discountLabelMap = {
          none: "할인 없음",
          student: "학생 할인(10%)",
          continuous: "연속 촬영 할인(15%)",
          student_continuous: "학생+연속(20%)",
        };

        const body = {
          RenterName: renterName,
          Contact: contact,
          ProjectName: projectName,
          Memo: memo,
          DiscountTypeLabel: discountLabelMap[discountType],
          CartMemo: cartMemo,
          Reservations: cart,
        };

        try {
          const res = await fetch("/.netlify/functions/equipment-reserve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const json = await res.json();
          if (json.ok) {
            alert("장비 예약 요청이 접수되었습니다!");
            document.getElementById("reserve-form").reset();
            cart.length = 0;
            renderCart();
          } else {
            alert("서버 오류: " + (json.error || ""));
          }
        } catch (e) {
          console.error(e);
          alert("연결에 문제가 있습니다. 잠시 후 다시 시도해 주세요.");
        }
      });

    // ---------- 초기 실행 ----------
    renderCart();
    loadGearList();
  </script>
</body>
</html>