<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gear Rental – fiducia collective</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-wrap">
        <div class="logo-mark"><span></span></div>
        <div class="logo-text">
          <div class="logo-text-main">FIDUCIA COLLECTIVE</div>
          <div class="logo-text-sub">Gear Rental · DayPay style</div>
        </div>
      </div>
      <nav>
        <a href="index.html">HOME</a>
        <a href="equipment.html" class="active">GEAR</a>
        <a href="ai-stillcut.html">AI STILLCUT</a>
      </nav>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <div class="hero-pill">
          <span class="hero-pill-dot"></span>
          FX3 · 짐벌 · 조명 · 패키지 렌탈
        </div>
        <h1 class="hero-title">
          장비 하나 고르고,<br />
          날짜 찍고,<br />
          장바구니에서 내역 확인까지.
        </h1>
        <p class="hero-desc">
          장비를 하나씩 세세하게 올려두고,<br />
          각 장비의 예약 일정을 실시간으로 확인하면서 예약할 수 있는 페이지입니다.
        </p>
        <div class="hero-meta">
          <span>장비별 예약 일정 확인</span>
          <span>학생 / 연속 촬영 할인 옵션</span>
          <span>Notion Gear Reservation DB 연동</span>
        </div>
      </div>
    </section>

    <main>
      <!-- 1. 장비 선택 + 날짜 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">장비 선택</div>
            <div class="card-sub">
              하나의 패키지를 선택하고, 대여 기간을 입력한 뒤 “장바구니 담기”를 눌러 주세요.
            </div>
          </div>
        </div>

        <div id="gear-list" class="form-meta-grid" style="margin-bottom: 12px;">
          <div class="form-meta-item gear-item" data-gear-name="FX3 BASIC KIT" data-price="90000">
            <span class="label">FX3 BASIC KIT · 90,000원/일</span>
            <span class="value">
              FX3 + 표준 줌렌즈 + 배터리 세트 · 라이트한 1인 촬영용
            </span>
          </div>
          <div class="form-meta-item gear-item" data-gear-name="FX3 GIMBAL KIT" data-price="140000">
            <span class="label">FX3 GIMBAL KIT · 140,000원/일</span>
            <span class="value">
              FX3 + 짐벌 + 광각/표준 렌즈 · 무빙이 많은 촬영용
            </span>
          </div>
          <div class="form-meta-item gear-item" data-gear-name="LIGHT & AUDIO KIT" data-price="70000">
            <span class="label">LIGHT & AUDIO KIT · 70,000원/일</span>
            <span class="value">
              LED 조명 2~3개 + 스탠드 + 무선 마이크 · 카메라 별도
            </span>
          </div>
          <div class="form-meta-item gear-item" data-gear-name="CUSTOM" data-price="0">
            <span class="label">CUSTOM · 협의 구성</span>
            <span class="value">
              세부 구성은 메모에 적어 주세요.
            </span>
          </div>
        </div>

        <p class="card-sub" id="selected-gear-text">
          선택된 장비: 아직 선택되지 않았습니다.
        </p>

        <div class="form-two-cols" style="margin-top: 10px;">
          <div class="input-group">
            <label>대여 시작일</label>
            <input type="date" id="rent-start" />
          </div>
          <div class="input-group">
            <label>반납일</label>
            <input type="date" id="rent-end" />
          </div>
        </div>

        <button type="button" id="add-to-cart" style="margin-top: 10px;">
          이 구성 장바구니 담기
        </button>

        <div id="gear-reserved" class="footer-note" style="margin-top:12px;">
          선택된 장비의 예약 일정을 불러오는 중입니다…
        </div>
      </section>

      <!-- 2. 장바구니 + 할인 / 내역서 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">장바구니 & 내역서</div>
            <div class="card-sub">
              담긴 구성을 확인하고, 할인 옵션을 적용할 수 있습니다.
            </div>
          </div>
        </div>

        <div id="cart-list">
          <p class="card-sub">아직 장바구니에 담긴 장비가 없습니다.</p>
        </div>

        <hr style="border-color: rgba(255,255,255,0.08); margin: 14px 0;" />

        <div class="form-two-cols">
          <div class="input-group">
            <label>할인 옵션</label>
            <select id="discount-type">
              <option value="none">할인 없음</option>
              <option value="student">학생 할인 (10%)</option>
              <option value="continuous">연속 촬영 할인 (15%)</option>
              <option value="student_continuous">학생 + 연속 (20%)</option>
            </select>
          </div>
          <div class="input-group">
            <label>할인 관련 메모</label>
            <input id="cart-memo" placeholder="예: 학생증 보유, 3일 연속 촬영 등" />
          </div>
        </div>

        <div id="summary" style="margin-top: 10px;" class="card-sub">
          총 금액: 0원
        </div>
      </section>

      <!-- 3. 예약자 정보 + 최종 전송 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">예약자 정보</div>
            <div class="card-sub">
              예약 확정 및 안내를 위해 필요한 최소 정보입니다.
            </div>
          </div>
        </div>

        <form id="reserve-form">
          <div class="form-two-cols">
            <div class="input-group">
              <label>예약자 이름 (RenterName)</label>
              <input id="RenterName" placeholder="예: 홍길동" />
            </div>
            <div class="input-group">
              <label>연락처 (Contact)</label>
              <input id="Contact" placeholder="010-0000-0000" />
            </div>
          </div>

          <div class="input-group">
            <label>프로젝트명 (ProjectName)</label>
            <input
              id="ProjectName"
              placeholder="예: 브랜드 필름 / 웨딩 / 룩북 / MV"
            />
          </div>

          <div class="input-group">
            <label>추가 메모 (Memo)</label>
            <textarea
              id="Memo"
              placeholder="픽업/반납 시간, 차량, 촬영 장소, 기타 특이사항 등을 적어 주세요."
            ></textarea>
          </div>

          <button type="button" id="submit-reservation">
            장비 예약 요청 보내기
          </button>
          <p class="footer-note">
            장바구니 내역과 할인 옵션이 장비별로 나뉘어 Notion Gear Reservation DB에 저장됩니다.  
            실제 결제/보증 관련 안내는 별도 연락으로 진행됩니다.
          </p>
        </form>
      </section>
    </main>
  </div>

  <script>
    // --- 공통 함수 ---
    function calcDays(startStr, endStr) {
      const s = new Date(startStr);
      const e = new Date(endStr);
      if (isNaN(s) || isNaN(e)) return 0;
      const diff = e - s;
      return diff < 0
        ? 0
        : Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
    }

    // --- 장비 선택 ---
    let selectedGear = null;
    const gearItems = document.querySelectorAll(".gear-item");
    const selectedGearText = document.getElementById("selected-gear-text");
    const reservedBox = document.getElementById("gear-reserved");

    async function loadGearReservations(gearName) {
      reservedBox.textContent = "선택된 장비의 예약 일정을 불러오는 중입니다…";
      try {
        const res = await fetch(
          "/.netlify/functions/gear-reservations?gear=" +
            encodeURIComponent(gearName)
        );
        const json = await res.json();
        if (!json.ok) {
          reservedBox.textContent =
            "예약 일정을 불러오지 못했습니다. (나중에 다시 확인해 주세요)";
          return;
        }
        const items = json.items || [];
        if (!items.length) {
          reservedBox.textContent =
            "이 장비는 아직 등록된 예약이 없습니다.";
          return;
        }
        const lines = items
          .map((r) => `${r.start} ~ ${r.end || r.start}`)
          .join("\n");
        reservedBox.textContent =
          "이미 예약된 일정:\n" + lines;
      } catch (e) {
        console.error(e);
        reservedBox.textContent =
          "예약 일정을 불러오는 중 오류가 발생했습니다.";
      }
    }

    gearItems.forEach((item) => {
      item.addEventListener("click", () => {
        gearItems.forEach((i) => (i.style.outline = "none"));
        item.style.outline = "1px solid rgba(255,255,255,0.6)";
        selectedGear = {
          gearName: item.dataset.gearName,
          pricePerDay: Number(item.dataset.price || 0),
        };
        selectedGearText.textContent =
          "선택된 장비: " +
          selectedGear.gearName +
          (selectedGear.pricePerDay
            ? " · " + selectedGear.pricePerDay.toLocaleString() + "원/일"
            : "");
        loadGearReservations(selectedGear.gearName);
      });
    });

    // --- 장바구니 ---
    const cart = [];
    const cartListEl = document.getElementById("cart-list");
    const discountSelect = document.getElementById("discount-type");
    const summaryEl = document.getElementById("summary");

    function renderCart() {
      if (!cart.length) {
        cartListEl.innerHTML =
          '<p class="card-sub">아직 장바구니에 담긴 장비가 없습니다.</p>';
        summaryEl.textContent = "총 금액: 0원";
        return;
      }

      const list = document.createElement("div");
      list.className = "form-meta-grid";

      let subtotal = 0;

      cart.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "form-meta-item";

        const label = document.createElement("span");
        label.className = "label";
        label.textContent =
          item.gearName +
          " · " +
          item.pricePerDay.toLocaleString() +
          "원/일";

        const value = document.createElement("span");
        value.className = "value";
        value.textContent =
          item.start +
          " ~ " +
          item.end +
          " · " +
          item.days +
          "일 · " +
          item.totalPrice.toLocaleString() +
          "원";

        subtotal += item.totalPrice;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn-secondary";
        removeBtn.style.fontSize = "10px";
        removeBtn.style.marginTop = "6px";
        removeBtn.textContent = "삭제";
        removeBtn.addEventListener("click", () => {
          cart.splice(idx, 1);
          renderCart();
        });

        div.appendChild(label);
        div.appendChild(value);
        div.appendChild(removeBtn);
        list.appendChild(div);
      });

      cartListEl.innerHTML = "";
      cartListEl.appendChild(list);

      let discountRate = 0;
      const type = discountSelect.value;
      if (type === "student") discountRate = 0.1;
      else if (type === "continuous") discountRate = 0.15;
      else if (type === "student_continuous") discountRate = 0.2;

      const discountAmount = Math.floor(subtotal * discountRate);
      const finalTotal = subtotal - discountAmount;

      summaryEl.innerHTML =
        "상품 금액: " +
        subtotal.toLocaleString() +
        "원<br>" +
        "할인: " +
        (discountAmount ? "- " + discountAmount.toLocaleString() + "원" : "0원") +
        "<br><strong>최종 결제 예상 금액: " +
        finalTotal.toLocaleString() +
        "원</strong>";
    }

    discountSelect.addEventListener("change", renderCart);

    document
      .getElementById("add-to-cart")
      .addEventListener("click", () => {
        const start = document.getElementById("rent-start").value;
        const end = document.getElementById("rent-end").value;

        if (!selectedGear) {
          alert("먼저 장비 하나를 선택해 주세요.");
          return;
        }
        if (!start || !end) {
          alert("대여 시작일과 반납일을 입력해 주세요.");
          return;
        }

        const days = calcDays(start, end);
        if (!days) {
          alert("기간이 잘못되었습니다.");
          return;
        }

        const totalPrice = selectedGear.pricePerDay * days;

        cart.push({
          gearName: selectedGear.gearName,
          pricePerDay: selectedGear.pricePerDay,
          start,
          end,
          days,
          totalPrice,
        });

        renderCart();
      });

    // --- 최종 예약 전송 ---
    document
      .getElementById("submit-reservation")
      .addEventListener("click", async () => {
        const renterName = document.getElementById("RenterName").value;
        const contact = document.getElementById("Contact").value;
        const projectName = document.getElementById("ProjectName").value;
        const memo = document.getElementById("Memo").value;
        const cartMemo = document.getElementById("cart-memo").value;
        const discountType = discountSelect.value;

        if (!renterName || !contact || !projectName) {
          alert("이름 / 연락처 / 프로젝트명은 꼭 입력해 주세요.");
          return;
        }
        if (!cart.length) {
          alert("장바구니에 최소 1개 이상의 장비를 담아 주세요.");
          return;
        }

        const discountLabelMap = {
          none: "할인 없음",
          student: "학생 할인(10%)",
          continuous: "연속 촬영 할인(15%)",
          student_continuous: "학생+연속(20%)",
        };

        const body = {
          RenterName: renterName,
          Contact: contact,
          ProjectName: projectName,
          Memo: memo,
          DiscountTypeLabel: discountLabelMap[discountType],
          CartMemo: cartMemo,
          Reservations: cart,
        };

        try {
          const res = await fetch("/.netlify/functions/equipment-reserve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const json = await res.json();
          if (json.ok) {
            alert("장비 예약 요청이 접수되었습니다!");
            document.getElementById("reserve-form").reset();
            cart.length = 0;
            renderCart();
          } else {
            alert("서버 오류: " + (json.error || ""));
          }
        } catch (e) {
          console.error(e);
          alert("연결에 문제가 있습니다. 잠시 후 다시 시도해 주세요.");
        }
      });

    // 초기 상태 렌더
    renderCart();
  </script>
</body>
</html>